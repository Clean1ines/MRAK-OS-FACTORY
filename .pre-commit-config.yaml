# Pre-commit hooks for MRAK-OS FACTORY

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-added-large-files
        args: ['--maxkb=5000']
      - id: check-merge-conflict
      - id: check-yaml
      - id: check-json
      - id: end-of-file-fixer
        exclude: ^frontend/src/api/generated/
#       - id: trailing-whitespace
# 
  # Backend: Python checks
  - repo: local
    hooks:
      - id: ensure-test-db
        name: Ensure test database is running
        entry: bash scripts/ensure_test_db.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      - id: pytest-quick
        name: Run pytest (quick mode)
        # #CHANGED: Run ensure_test_db.sh BEFORE pytest
        entry: bash -c 'bash scripts/ensure_test_db.sh && python -m pytest -q --tb=no -x tests/ 2>/dev/null || echo "⚠️ pytest skipped or passed"'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        exclude: '^\.github/|^frontend/'

      - id: backend-type-check
        name: Type check backend (mypy - optional)
        entry: bash -c 'python -m mypy --ignore-missing-imports . 2>/dev/null || true'
        language: system
        pass_filenames: false
        always_run: false
        stages: [pre-commit]
        files: \.py$

  # Frontend: TypeScript + lint + tests
  - repo: local
    hooks:
      - id: frontend-type-check
        name: TypeScript type check
        entry: bash -c 'cd frontend && npm run type-check'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        files: ^frontend/

      - id: frontend-lint
        name: ESLint check (warnings allowed for now)
        entry: bash -c 'cd frontend && npm run lint -- --max-warnings=-1'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        files: ^frontend/

      - id: frontend-test-quick
        name: Run vitest (quick mode)
        entry: bash -c 'cd frontend && CI=true npm run test:run -- --reporter=dot --no-coverage --run'
        language: system
        pass_filenames: false
        always_run: false
        stages: [pre-commit]
        files: ^frontend/.*\.(test|spec)\.(ts|tsx)$

  # Pre-push only hooks (slower checks)
  - repo: local
    hooks:
      - id: docker-build-check
        name: Build Docker image (pre-push only)
        entry: bash verify_docker.sh
        language: system
        pass_filenames: false
        always_run: false
        stages: [pre-push]  # ← Только перед пушем

  # E2E Tests — pre-push only (solo-dev optimized)
  - repo: local
    hooks:
      - id: e2e-tests-workspace
        name: Playwright E2E (TASK-012 workspace flows)
        entry: bash e2e-run.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]
        files: ^frontend/|^tests/e2e/
        # Soft-fail: выводим ошибку но не блокируем пуш (уберите || true для strict mode)
        # Для solo-dev: лучше видеть ошибку чем блокировать работу
