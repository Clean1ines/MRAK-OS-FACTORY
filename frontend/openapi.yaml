openapi: 3.0.0
info:
  title: MRAK-OS Factory API
  description: API –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞–º–∏, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏, —Å–µ—Å—Å–∏—è–º–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏ workflow.
  version: 1.0.0
servers:
  - url: https://mrak-os-factory.onrender.com
    description: –ü—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
  - url: http://localhost:8000
    description: –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

paths:
  # ==================== –ü—Ä–æ–µ–∫—Ç—ã ====================
  /api/projects:
    get:
      operationId: getProjects
      summary: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
      tags:
        - projects
      responses:
        '200':
          description: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      operationId: createProject
      summary: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
      tags:
        - projects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreate'
      responses:
        '200':
          description: –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/projects/{project_id}:
    delete:
      operationId: deleteProject
      summary: –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç (–∫–∞—Å–∫–∞–¥–Ω–æ —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)
      tags:
        - projects
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –ü—Ä–æ–µ–∫—Ç —É–¥–∞–ª—ë–Ω
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/projects/{project_id}/unlock:
    post:
      operationId: unlockProject
      summary: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –ø–∞—Ä–æ–ª–µ–º (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie)
      tags:
        - projects
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
      responses:
        '200':
          description: –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω, cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
        '400':
          description: –ü—Ä–æ–µ–∫—Ç –Ω–µ –∑–∞—â–∏—â—ë–Ω –ø–∞—Ä–æ–ª–µ–º
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/projects/{project_id}/set_password:
    post:
      operationId: setProjectPassword
      summary: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
      tags:
        - projects
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
                  description: –ï—Å–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äì –ø–∞—Ä–æ–ª—å —É–¥–∞–ª—è–µ—Ç—Å—è
      security:
        - MasterKeyAuth: []
      responses:
        '200':
          description: –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω
        '400':
          description: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã ====================
  /api/projects/{project_id}/artifacts:
    get:
      operationId: getArtifacts
      summary: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
      tags:
        - artifacts
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: type
          in: query
          required: false
          schema:
            type: string
          description: –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      responses:
        '200':
          description: –°–ø–∏—Å–æ–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Artifact'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/artifact:
    post:
      operationId: createArtifact
      summary: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      tags:
        - artifacts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtifactCreate'
      responses:
        '200':
          description: –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ/—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  generated:
                    type: boolean
        '404':
          description: –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/latest_artifact:
    get:
      operationId: getLatestArtifact
      summary: –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –ø–æ —Ä–æ–¥–∏—Ç–µ–ª—é –∏ —Ç–∏–ø—É
      tags:
        - artifacts
      parameters:
        - name: parent_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: type
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º
          content:
            application/json:
              schema:
                type: object
                properties:
                  exists:
                    type: boolean
                  artifact_id:
                    type: string
                    format: uuid
                  content:
                    type: object
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/validate_artifact:
    post:
      operationId: validateArtifact
      summary: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (VALIDATED / REJECTED)
      tags:
        - artifacts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                artifact_id:
                  type: string
                  format: uuid
                status:
                  type: string
                  enum: [VALIDATED, REJECTED]
      responses:
        '200':
          description: –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: updated
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/artifact/{artifact_id}:
    delete:
      operationId: deleteArtifact
      summary: –£–¥–∞–ª–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–∫–∞—Å–∫–∞–¥–Ω–æ)
      tags:
        - artifacts
      parameters:
        - name: artifact_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –ê—Ä—Ç–µ—Ñ–∞–∫—Ç —É–¥–∞–ª—ë–Ω
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/generate_artifact:
    post:
      operationId: generateArtifact
      summary: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å —É—á—ë—Ç–æ–º —Ñ–∏–¥–±–µ–∫–∞ (—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã)
      tags:
        - artifacts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateArtifactRequest'
      responses:
        '200':
          description: –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: object
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/save_artifact_package:
    post:
      operationId: saveArtifactPackage
      summary: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–∫–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (—Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
      tags:
        - artifacts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SavePackageRequest'
      responses:
        '200':
          description: –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–∏–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  duplicate:
                    type: boolean
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/projects/{project_id}/messages:
    get:
      operationId: getProjectMessages
      summary: –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (LLMResponse) –ø—Ä–æ–µ–∫—Ç–∞
      tags:
        - artifacts
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –°–ø–∏—Å–æ–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Ç–∏–ø–∞ LLMResponse
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Artifact'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== –¢–∏–ø—ã –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ ====================
  /api/artifact-types:
    get:
      operationId: getArtifactTypes
      summary: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
      tags:
        - artifact-types
      responses:
        '200':
          description: –ú–∞—Å—Å–∏–≤ —Ç–∏–ø–æ–≤
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ArtifactType'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      operationId: createArtifactType
      summary: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (–∞–¥–º–∏–Ω)
      tags:
        - artifact-types
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtifactTypeCreate'
      security:
        - MasterKeyAuth: []
      responses:
        '201':
          description: –¢–∏–ø —Å–æ–∑–¥–∞–Ω
          content:
            application/json:
              schema:
                type: object
                properties:
                  type:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/artifact-types/{type}:
    get:
      operationId: getArtifactType
      summary: –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
      tags:
        - artifact-types
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactType'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      operationId: updateArtifactType
      summary: –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞ (–∞–¥–º–∏–Ω)
      tags:
        - artifact-types
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: –ß–∞—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –ø–æ–ª—è (schema, allowed_parents, requires_clarification, icon)
      security:
        - MasterKeyAuth: []
      responses:
        '200':
          description: –û–±–Ω–æ–≤–ª–µ–Ω–æ
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      operationId: deleteArtifactType
      summary: –£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (–∞–¥–º–∏–Ω)
      tags:
        - artifact-types
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
      security:
        - MasterKeyAuth: []
      responses:
        '200':
          description: –£–¥–∞–ª–µ–Ω–æ
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== –°–µ—Å—Å–∏–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è ====================
  /api/clarification/start:
    post:
      operationId: startClarification
      summary: –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —É—Ç–æ—á–Ω–µ–Ω–∏—è
      tags:
        - clarification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartClarificationRequest'
      responses:
        '200':
          description: –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClarificationSessionResponse'
        '400':
          description: –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –Ω–∞–π–¥–µ–Ω
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/clarification/{session_id}/message:
    post:
      operationId: sendClarificationMessage
      summary: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–µ—Å—Å–∏—é –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
      tags:
        - clarification
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageRequest'
      responses:
        '200':
          description: –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClarificationSessionResponse'
        '400':
          description: –°–µ—Å—Å–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/clarification/{session_id}:
    get:
      operationId: getClarificationSession
      summary: –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
      tags:
        - clarification
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –°–µ—Å—Å–∏—è
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClarificationSessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/clarification/{session_id}/complete:
    post:
      operationId: completeClarificationSession
      summary: –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å completed)
      tags:
        - clarification
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: completed
                  session_id:
                    type: string
        '400':
          description: –°–µ—Å—Å–∏—è —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/projects/{project_id}/clarification/active:
    get:
      operationId: getActiveClarificationSessions
      summary: –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø—Ä–æ–µ–∫—Ç–∞
      tags:
        - clarification
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –ú–∞—Å—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    target_artifact_type:
                      type: string
                    created_at:
                      type: string
                      format: date-time
                    updated_at:
                      type: string
                      format: date-time
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== Workflow ====================
  /api/workflows:
    get:
      operationId: getWorkflows
      summary: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö workflow
      tags:
        - workflows
      responses:
        '200':
          description: –ú–∞—Å—Å–∏–≤ workflow
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Workflow'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      operationId: createWorkflow
      summary: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π workflow
      tags:
        - workflows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowCreate'
      responses:
        '201':
          description: Workflow —Å–æ–∑–¥–∞–Ω
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/workflows/{workflow_id}:
    get:
      operationId: getWorkflow
      summary: –ü–æ–ª—É—á–∏—Ç—å workflow —Å —É–∑–ª–∞–º–∏ –∏ —Ä—ë–±—Ä–∞–º–∏
      tags:
        - workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowDetail'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      operationId: updateWorkflow
      summary: –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ workflow
      tags:
        - workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowUpdate'
      responses:
        '200':
          description: –û–±–Ω–æ–≤–ª–µ–Ω–æ
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      operationId: deleteWorkflow
      summary: –£–¥–∞–ª–∏—Ç—å workflow
      tags:
        - workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –£–¥–∞–ª–µ–Ω–æ
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/workflows/{workflow_id}/nodes:
    post:
      operationId: createWorkflowNode
      summary: –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª –≤ workflow
      tags:
        - workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowNodeCreate'
      responses:
        '201':
          description: –£–∑–µ–ª —Å–æ–∑–¥–∞–Ω
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
        '400':
          description: –£–∑–µ–ª —Å —Ç–∞–∫–∏–º node_id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/workflows/nodes/{node_record_id}:
    put:
      operationId: updateWorkflowNode
      summary: –û–±–Ω–æ–≤–∏—Ç—å —É–∑–µ–ª
      tags:
        - workflows
      parameters:
        - name: node_record_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowNodeUpdate'
      responses:
        '200':
          description: –û–±–Ω–æ–≤–ª–µ–Ω–æ
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      operationId: deleteWorkflowNode
      summary: –£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª
      tags:
        - workflows
      parameters:
        - name: node_record_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –£–¥–∞–ª–µ–Ω–æ
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/workflows/{workflow_id}/edges:
    post:
      operationId: createWorkflowEdge
      summary: –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—Ä–æ –≤ workflow
      tags:
        - workflows
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowEdgeCreate'
      responses:
        '201':
          description: –†–µ–±—Ä–æ —Å–æ–∑–¥–∞–Ω–æ
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
        '400':
          description: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —É–∑–ª—ã (–Ω–µ –Ω–∞–π–¥–µ–Ω—ã)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/workflows/edges/{edge_record_id}:
    delete:
      operationId: deleteWorkflowEdge
      summary: –£–¥–∞–ª–∏—Ç—å —Ä–µ–±—Ä–æ
      tags:
        - workflows
      parameters:
        - name: edge_record_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –£–¥–∞–ª–µ–Ω–æ
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/workflow/next:
    get:
      operationId: getNextWorkflowStep
      summary: –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∂–∏–º)
      tags:
        - workflows
      parameters:
        - name: project_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
          content:
            application/json:
              schema:
                type: object
                properties:
                  next_stage:
                    type: string
                    description: –¢–∏–ø —Å–ª–µ–¥—É—é—â–µ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –∏–ª–∏ 'finished'
                  prompt_type:
                    type: string
                  parent_id:
                    type: string
                    format: uuid
                  description:
                    type: string
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/workflow/execute_next:
    post:
      operationId: executeNextWorkflowStep
      summary: –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç)
      tags:
        - workflows
      parameters:
        - name: project_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: model
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–≥–∞ (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç)
          content:
            application/json:
              schema:
                type: object
                properties:
                  artifact_id:
                    type: string
                  artifact_type:
                    type: string
                  content:
                    type: object
                  parent_id:
                    type: string
                  next_stage:
                    type: string
                  existing:
                    type: boolean
        '400':
          description: –ù–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== –ú–æ–¥–µ–ª–∏ –∏ —Ä–µ–∂–∏–º—ã ====================
  /api/models:
    get:
      operationId: getModels
      summary: –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö LLM-–º–æ–¥–µ–ª–µ–π
      tags:
        - modes
      responses:
        '200':
          description: –ú–∞—Å—Å–∏–≤ –º–æ–¥–µ–ª–µ–π
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/modes:
    get:
      operationId: getModes
      summary: –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤
      tags:
        - modes
      responses:
        '200':
          description: –ú–∞—Å—Å–∏–≤ —Ä–µ–∂–∏–º–æ–≤
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    default:
                      type: boolean
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/analyze:
    post:
      operationId: analyzeStream
      summary: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ LLM –≤ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
      tags:
        - modes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                prompt:
                  type: string
                mode:
                  type: string
                model:
                  type: string
                project_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: –°—Ç—Ä–∏–º–∏–Ω–≥ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (text/plain)
          content:
            text/plain:
              schema:
                type: string
        '400':
          description: –ù–µ–≤–µ—Ä–Ω—ã–π JSON –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç prompt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
          content:
            text/plain:
              schema:
                type: string
                example: "üî¥ SYSTEM_CRITICAL_ERROR: ..."

components:
  securitySchemes:
    MasterKeyAuth:
      type: apiKey
      in: header
      name: X-Master-Key
      description: –ö–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º.

  schemas:
    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        password_hash:
          type: string
          nullable: true

    ProjectCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string

    Artifact:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
        parent_id:
          type: string
          format: uuid
          nullable: true
        content:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        version:
          type: string
        status:
          type: string
          enum: [DRAFT, GENERATED, VALIDATED, REJECTED]
        summary:
          type: string

    ArtifactCreate:
      type: object
      required:
        - project_id
        - artifact_type
        - content
      properties:
        project_id:
          type: string
          format: uuid
        artifact_type:
          type: string
        content:
          type: string
        parent_id:
          type: string
          format: uuid
          nullable: true
        generate:
          type: boolean
        model:
          type: string

    GenerateArtifactRequest:
      type: object
      required:
        - artifact_type
        - parent_id
        - project_id
      properties:
        artifact_type:
          type: string
        parent_id:
          type: string
          format: uuid
        feedback:
          type: string
        model:
          type: string
        project_id:
          type: string
          format: uuid
        existing_content:
          type: object
          nullable: true

    SavePackageRequest:
      type: object
      required:
        - project_id
        - parent_id
        - artifact_type
        - content
      properties:
        project_id:
          type: string
          format: uuid
        parent_id:
          type: string
          format: uuid
        artifact_type:
          type: string
        content:
          type: object

    ArtifactType:
      type: object
      properties:
        type:
          type: string
        schema:
          type: object
        allowed_parents:
          type: array
          items:
            type: string
        requires_clarification:
          type: boolean
        icon:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ArtifactTypeCreate:
      type: object
      required:
        - type
        - schema
      properties:
        type:
          type: string
        schema:
          type: object
        allowed_parents:
          type: array
          items:
            type: string
        requires_clarification:
          type: boolean
        icon:
          type: string

    StartClarificationRequest:
      type: object
      required:
        - project_id
        - target_artifact_type
      properties:
        project_id:
          type: string
          format: uuid
        target_artifact_type:
          type: string
        model:
          type: string

    MessageRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string

    ClarificationSessionResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        target_artifact_type:
          type: string
        history:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [user, assistant]
              content:
                type: string
              timestamp:
                type: string
                format: date-time
        status:
          type: string
          enum: [active, completed]
        context_summary:
          type: object
          nullable: true
        final_artifact_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Workflow:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        is_default:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    WorkflowCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
        is_default:
          type: boolean

    WorkflowUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        is_default:
          type: boolean

    WorkflowNodeCreate:
      type: object
      required:
        - node_id
        - prompt_key
        - position_x
        - position_y
      properties:
        node_id:
          type: string
        prompt_key:
          type: string
        config:
          type: object
        position_x:
          type: number
          format: float
        position_y:
          type: number
          format: float

    WorkflowNodeUpdate:
      type: object
      properties:
        prompt_key:
          type: string
        config:
          type: object
        position_x:
          type: number
          format: float
        position_y:
          type: number
          format: float

    WorkflowEdgeCreate:
      type: object
      required:
        - source_node
        - target_node
      properties:
        source_node:
          type: string
        target_node:
          type: string
        source_output:
          type: string
          default: output
        target_input:
          type: string
          default: input

    WorkflowDetail:
      type: object
      properties:
        workflow:
          $ref: '#/components/schemas/Workflow'
        nodes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              workflow_id:
                type: string
              node_id:
                type: string
              prompt_key:
                type: string
              config:
                type: object
              position_x:
                type: number
              position_y:
                type: number
              created_at:
                type: string
                format: date-time
              updated_at:
                type: string
                format: date-time
        edges:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              workflow_id:
                type: string
              source_node:
                type: string
              target_node:
                type: string
              source_output:
                type: string
              target_input:
                type: string
              created_at:
                type: string
                format: date-time

    Error:
      type: object
      properties:
        error:
          type: string

  responses:
    NotFound:
      description: –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    BadRequest:
      description: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    ValidationError:
      description: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
    InternalServerError:
      description: –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'