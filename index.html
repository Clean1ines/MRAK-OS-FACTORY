<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MRAK-OS TERMINAL</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; background-color: #050505; }
        /* Скрываем скроллбар но оставляем прокрутку */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .typing-cursor::after {
            content: '█';
            animation: blink 1s step-start infinite;
            color: #22c55e;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="text-gray-300 h-screen flex flex-col overflow-hidden">

    <header class="border-b border-gray-800 p-4 flex justify-between items-center bg-[#0a0a0a] z-10">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)] animate-pulse"></div>
            <h1 class="font-bold tracking-widest text-gray-100">MRAK-OS <span class="text-green-600 text-xs align-top">v3.1</span></h1>
        </div>
        <div class="text-xs text-gray-600 hidden md:block">SYS.CONNECTED // PORT:8000</div>
    </header>

    <main id="terminal" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 no-scrollbar scroll-smooth">
        <div class="text-gray-500 text-sm mb-8">
            > SYSTEM INITIALIZED...<br>
            > CONNECTION ESTABLISHED.<br>
            > WAITING FOR INPUT...
        </div>
        <div id="messages" class="space-y-6"></div>
        <div id="scroll-anchor"></div>
    </main>

    <footer class="p-4 bg-[#0a0a0a] border-t border-gray-800">
        <div class="relative max-w-4xl mx-auto">
            <textarea 
                id="input" 
                class="w-full bg-[#111] text-gray-200 p-4 pr-16 rounded-lg border border-gray-700 focus:border-green-600 focus:ring-1 focus:ring-green-900 outline-none resize-none h-14 max-h-32 transition-all shadow-lg placeholder-gray-700"
                placeholder="Введите команду..."
                rows="1"
            ></textarea>
            
            <button id="send-btn" class="absolute right-2 bottom-2 text-gray-500 hover:text-green-500 p-2 transition-colors disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
        </div>
        <div class="text-center mt-2 text-[10px] text-gray-700 uppercase tracking-widest">
            Enter to send / Shift+Enter for new line
        </div>
    </footer>

    <script>
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send-btn');
        const messagesDiv = document.getElementById('messages');
        const terminal = document.getElementById('terminal');
        const scrollAnchor = document.getElementById('scroll-anchor');

        // Авто-высота textarea
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = '56px'; // Возврат к исходному
        });

        // Обработка Enter
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                startGeneration();
            }
        });

        sendBtn.addEventListener('click', startGeneration);

        async function startGeneration() {
            const text = input.value.trim();
            if (!text) return;

            // Блокируем ввод
            input.value = '';
            input.style.height = '56px';
            input.disabled = true;
            sendBtn.disabled = true;

            // 1. Рисуем сообщение пользователя
            const userMsg = document.createElement('div');
            userMsg.className = 'flex justify-end';
            userMsg.innerHTML = `<div class="bg-[#1a1a1a] text-gray-300 px-4 py-3 rounded-2xl rounded-tr-sm border border-gray-800 max-w-[85%] whitespace-pre-wrap shadow-md">${escapeHtml(text)}</div>`;
            messagesDiv.appendChild(userMsg);
            scrollToBottom();

            // 2. Создаем контейнер для ответа AI
            const aiMsgContainer = document.createElement('div');
            aiMsgContainer.className = 'flex justify-start';
            const aiContent = document.createElement('div');
            aiContent.className = 'text-green-400 max-w-[90%] leading-relaxed typing-cursor whitespace-pre-wrap'; 
            // Префикс системы
            aiContent.innerHTML = '<span class="text-green-800 font-bold select-none">MRAK-OS > </span>';
            
            aiMsgContainer.appendChild(aiContent);
            messagesDiv.appendChild(aiMsgContainer);

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt: text})
                });

                if (!response.ok) throw new Error("Network Error");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    // Добавляем текст
                    aiContent.innerHTML += escapeHtml(chunk);
                    scrollToBottom();
                }

            } catch (e) {
                aiContent.innerHTML += `<span class="text-red-500">\n[SYSTEM ERROR]: ${e.message}</span>`;
            } finally {
                // Убираем курсор и разблокируем
                aiContent.classList.remove('typing-cursor');
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            scrollAnchor.scrollIntoView({ behavior: "smooth" });
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>