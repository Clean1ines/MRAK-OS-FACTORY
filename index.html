<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRAK-OS | DYNAMIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link 
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0a0a0b;
            color: #d1d5db;
        }
        .markdown-body {
            font-size: 1.2rem;
            line-height: 1.7;
        }
        .markdown-body code {
            color: #6ee7b7;
            background: #1a1a1c;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }
        .markdown-body pre {
            background: #000;
            border: 1px solid #222;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.2rem 0;
            overflow-x: auto;
        }
        .streaming::after {
            content: '▋';
            animation: blink 1s infinite;
            color: #059669;
        }
        @keyframes blink {
            0%,100%{opacity:1;}
            50%{opacity:0;}
        }
        select option {
            background: #111;
            color: #d1d5db;
        }
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
        .message-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .message-toolbar button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .message-toolbar button:hover {
            background: #111;
        }
        /* модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            padding: 1.5rem;
            position: relative;
        }
        .requirement-card {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #1a1a1c;
        }
        .requirement-card input, .requirement-card textarea {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            width: 100%;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="h-screen flex flex-col antialiased overflow-hidden">

    <nav class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-black/40 backdrop-blur-xl shrink-0">
        <div class="flex items-center gap-6">
            <div class="flex flex-col">
                <span class="text-[8px] tracking-[0.3em] text-emerald-500 font-bold uppercase">Prompt_Mode</span>
                <select id="mode-select" class="bg-transparent text-[10px] text-white font-mono outline-none cursor-pointer">
                    <option value="01_CORE">01: CORE_SYSTEM</option>
                    <option value="02_UI_UX">02: UI_UX_DESIGN</option>
                    <option value="03_SOFT_ENG">03: TITAN_DEV</option>
                    <option value="04_FAILURE">04: FAILURE_ANALYSIS</option>
                    <option value="06_TRANSLATOR">06: PROMPT_ENG</option>
                    <option value="07_BYPASS">07: RAW_BYPASS</option>
                    <option value="07_INTEGRATION_PLAN">07: INTEGRATION_PLAN</option>
                    <option value="08_PROMPT_COUNCIL">08: PROMPT_COUNCIL</option>
                    <option value="09_ALGO_COUNCIL">09: ALGO_COUNCIL</option>
                    <option value="10_FULL_CODE_GEN">10: FULL_CODE_GEN</option>
                    <option value="11_REQ_COUNCIL">11: REQ_COUNCIL</option>
                    <option value="12_SELF_ANALYSIS_FACTORY">12: SELF_ANALYSIS_FACTORY</option>
                    <option value="13_ARTIFACT_OUTPUT">13_ARTIFACT_OURPUT</option>
                    <option value="14_PRODUCT_COUNCIL">14: PRODUCT_COUNCIL</option>
                </select>
            </div>
            <div class="flex flex-col">
                <span class="text-[8px] tracking-[0.3em] text-zinc-500 font-bold uppercase">Neural_Model</span>
                <select id="model-select" class="bg-transparent text-[10px] text-white font-mono outline-none cursor-pointer">
                    <option>Loading models...</option>
                </select>
            </div>
        </div>
        <div class="flex gap-4 text-[9px] font-mono text-zinc-600">
            <span>TOKENS: <b id="q-tokens" class="text-zinc-400">---</b></span>
            <span>REQ: <b id="q-req" class="text-zinc-400">---</b></span>
        </div>
    </nav>

    <div class="px-6 py-2 bg-emerald-500/5 border-b border-white/5 text-[9px] text-zinc-500 flex justify-between">
        <span id="status-text">SYSTEM_READY</span>
        <span id="token-count">EST_COST: 0 TOKENS</span>
    </div>

    <!-- Блок управления проектами и артефактами -->
    <div class="px-6 py-2 bg-zinc-900 border-b border-white/5 flex flex-wrap items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">Проект:</span>
            <select id="project-select" class="bg-zinc-800 text-white text-sm px-3 py-1 rounded border border-white/10 w-64">
                <option value="">-- Выберите проект --</option>
            </select>
            <button id="new-project-btn" class="bg-emerald-600/20 text-emerald-500 text-xs px-3 py-1 rounded hover:bg-emerald-600/30">+ Новый</button>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">Тип:</span>
            <select id="artifact-type-select" class="bg-zinc-800 text-white text-sm px-3 py-1 rounded border border-white/10">
                <option value="BusinessIdea">Бизнес-идея</option>
                <option value="ProductCouncilAnalysis">Анализ продуктового совета</option>
                <option value="BusinessRequirement">Бизнес-требование</option>
                <option value="ReqEngineeringAnalysis">Анализ инженерии требований</option>
                <option value="FunctionalRequirement">Функциональное требование</option>
                <option value="CodeArtifact">Код</option>
            </select>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">Родитель:</span>
            <select id="parent-select" class="bg-zinc-800 text-white text-sm px-3 py-1 rounded border border-white/10 w-64">
                <option value="">-- нет --</option>
            </select>
            <button id="refresh-parents" class="bg-zinc-700 text-white text-xs px-2 py-1 rounded">⟲</button>
        </div>
        <div class="flex items-center gap-2">
            <label class="flex items-center gap-1 text-xs">
                <input type="checkbox" id="generate-checkbox" class="form-checkbox h-4 w-4 text-emerald-500 bg-zinc-800 border-white/10 rounded"> Генерировать
            </label>
        </div>
        <button id="generate-br-btn" class="bg-emerald-600/20 text-emerald-500 text-xs px-3 py-1 rounded hover:bg-emerald-600/30" style="display:none;">Создать бизнес-требования</button>
        <button id="save-artifact-btn" class="bg-emerald-600/20 text-emerald-500 text-xs px-3 py-1 rounded hover:bg-emerald-600/30">Сохранить артефакт</button>
    </div>

    <!-- Модальное окно для просмотра/редактирования требований -->
    <div id="req-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-bold mb-4">Сгенерированные бизнес-требования</h2>
            <div id="requirements-container"></div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-req-btn" class="px-3 py-1 bg-zinc-700 rounded">Отмена</button>
                <button id="regenerate-req-btn" class="px-3 py-1 bg-blue-600/20 text-blue-500 rounded">Перегенерировать</button>
                <button id="save-req-btn" class="px-3 py-1 bg-emerald-600/20 text-emerald-500 rounded">Сохранить все</button>
            </div>
        </div>
    </div>

    <main id="terminal" class="flex-1 overflow-y-auto px-6 scroll-smooth">
        <div id="messages" class="max-w-3xl mx-auto py-12 space-y-12"></div>
        <div id="scroll-anchor" class="h-32"></div>
    </main>

    <footer class="p-6 bg-gradient-to-t from-black to-transparent shrink-0">
        <div class="max-w-3xl mx-auto">
            <div class="flex items-end gap-3 bg-[#111113] border border-white/5 rounded-2xl p-3 transition-all duration-300 focus-within:border-emerald-500">
                <textarea 
                    id="input"
                    class="w-full bg-transparent text-gray-200 py-2 px-3 outline-none resize-none h-[44px] max-h-[300px] text-sm"
                    placeholder="Введите запрос..."></textarea>
                <button id="send-btn" class="p-2 bg-emerald-600/10 text-emerald-500 rounded-xl hover:bg-emerald-600/20 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2"/>
                    </svg>
                </button>
            </div>
        </div>
    </footer>

    <script>
        const input = document.getElementById("input");
        const sendBtn = document.getElementById("send-btn");
        const messagesDiv = document.getElementById("messages");
        const scrollAnchor = document.getElementById("scroll-anchor");
        const modelSelect = document.getElementById("model-select");
        const statusText = document.getElementById("status-text");
        const projectSelect = document.getElementById("project-select");
        const newProjectBtn = document.getElementById("new-project-btn");
        const artifactTypeSelect = document.getElementById("artifact-type-select");
        const parentSelect = document.getElementById("parent-select");
        const refreshParentsBtn = document.getElementById("refresh-parents");
        const generateCheckbox = document.getElementById("generate-checkbox");
        const saveArtifactBtn = document.getElementById("save-artifact-btn");
        const generateBrBtn = document.getElementById("generate-br-btn");
        const reqModal = document.getElementById("req-modal");
        const requirementsContainer = document.getElementById("requirements-container");
        const cancelReqBtn = document.getElementById("cancel-req-btn");
        const regenerateReqBtn = document.getElementById("regenerate-req-btn");
        const saveReqBtn = document.getElementById("save-req-btn");

        let currentProjectId = localStorage.getItem("selectedProjectId") || "";
        const parentData = {};
        let currentRequirements = [];
        let currentAnalysisId = null;
        let currentFeedback = "";

        marked.setOptions({ gfm: true, breaks: true });

        input.oninput = function () {
            this.style.height = "auto";
            this.style.height = this.scrollHeight + "px";
            document.getElementById("token-count").innerText = `EST_COST: ~${Math.ceil(this.value.length / 4)} TOKENS`;
        };

        async function loadProjects() {
            try {
                const res = await fetch("/api/projects");
                const projects = await res.json();
                projectSelect.innerHTML = '<option value="">-- Выберите проект --</option>';
                projects.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.id;
                    opt.innerText = p.name;
                    if (p.id === currentProjectId) opt.selected = true;
                    projectSelect.appendChild(opt);
                });
                if (currentProjectId && !projects.some(p => p.id === currentProjectId)) {
                    currentProjectId = "";
                    localStorage.removeItem("selectedProjectId");
                }
            } catch (e) {
                console.error("Failed to load projects", e);
            }
        }

        newProjectBtn.onclick = async () => {
            const name = prompt("Введите название проекта:");
            if (!name) return;
            try {
                const res = await fetch("/api/projects", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, description: "" })
                });
                const data = await res.json();
                await loadProjects();
                projectSelect.value = data.id;
                currentProjectId = data.id;
                localStorage.setItem("selectedProjectId", currentProjectId);
                await loadParents();
            } catch (e) {
                alert("Ошибка создания проекта");
            }
        };

        async function loadParents() {
            if (!currentProjectId) return;
            try {
                const res = await fetch(`/api/projects/${currentProjectId}/artifacts`);
                const artifacts = await res.json();
                parentSelect.innerHTML = '<option value="">-- нет --</option>';
                for (let key in parentData) delete parentData[key];
                artifacts.forEach(a => {
                    parentData[a.id] = a.type;
                    const opt = document.createElement("option");
                    opt.value = a.id;
                    opt.innerText = `${a.type} (${a.created_at}) : ${a.summary}`;
                    parentSelect.appendChild(opt);
                });
                updateGenerateBrButton();
            } catch (e) {
                console.error("Failed to load parents", e);
            }
        }

        refreshParentsBtn.onclick = loadParents;

        projectSelect.addEventListener("change", function() {
            currentProjectId = this.value;
            if (currentProjectId) {
                localStorage.setItem("selectedProjectId", currentProjectId);
                loadParents();
            } else {
                localStorage.removeItem("selectedProjectId");
                parentSelect.innerHTML = '<option value="">-- нет --</option>';
                generateBrBtn.style.display = 'none';
            }
        });

        parentSelect.addEventListener('change', updateGenerateBrButton);

        function updateGenerateBrButton() {
            const selectedId = parentSelect.value;
            const selectedType = parentData[selectedId];
            if (selectedType === 'ProductCouncilAnalysis') {
                generateBrBtn.style.display = 'inline-block';
            } else {
                generateBrBtn.style.display = 'none';
            }
        }

        saveArtifactBtn.onclick = async () => {
            const content = input.value.trim();
            if (!content) {
                alert("Введите содержимое артефакта");
                return;
            }
            if (!currentProjectId) {
                alert("Сначала выберите проект");
                return;
            }
            const artifactType = artifactTypeSelect.value;
            const parentId = parentSelect.value || null;
            const generate = generateCheckbox.checked;
            const model = modelSelect.value;

            try {
                const res = await fetch("/api/artifact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        project_id: currentProjectId,
                        artifact_type: artifactType,
                        content: content,
                        parent_id: parentId,
                        generate: generate,
                        model: model
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`Артефакт сохранён, ID: ${data.id}`);
                    input.value = "";
                    input.style.height = "44px";
                    await loadParents();
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            } catch (e) {
                alert(`Ошибка сети: ${e}`);
            }
        };

        // Генерация бизнес-требований с показом модального окна
        generateBrBtn.onclick = async () => {
            const analysisId = parentSelect.value;
            if (!analysisId) return;
            const feedback = input.value.trim();
            const model = modelSelect.value;
            currentAnalysisId = analysisId;
            currentFeedback = feedback;

            try {
                const res = await fetch("/api/generate_business_requirements", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        analysis_id: analysisId,
                        feedback: feedback,
                        model: model,
                        project_id: currentProjectId
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    currentRequirements = data.requirements;
                    renderRequirements();
                    reqModal.style.display = 'flex';
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            } catch (e) {
                alert(`Ошибка сети: ${e}`);
            }
        };

        function renderRequirements() {
            requirementsContainer.innerHTML = '';
            currentRequirements.forEach((req, index) => {
                const card = document.createElement('div');
                card.className = 'requirement-card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold">Требование #${index+1}</span>
                        <button class="text-red-500 text-xs" onclick="removeRequirement(${index})">Удалить</button>
                    </div>
                    <input type="text" class="w-full" placeholder="Описание" value="${escapeHtml(req.description || '')}" data-index="${index}" data-field="description">
                    <input type="text" class="w-full" placeholder="Приоритет (HIGH/MEDIUM/LOW)" value="${escapeHtml(req.priority || '')}" data-index="${index}" data-field="priority">
                    <input type="text" class="w-full" placeholder="Заинтересованная сторона" value="${escapeHtml(req.stakeholder || '')}" data-index="${index}" data-field="stakeholder">
                    <textarea class="w-full" placeholder="Критерии приемки (каждый с новой строки)" rows="3" data-index="${index}" data-field="acceptance_criteria">${escapeHtml(Array.isArray(req.acceptance_criteria) ? req.acceptance_criteria.join('\n') : req.acceptance_criteria || '')}</textarea>
                    <textarea class="w-full" placeholder="Бизнес-ценность" rows="2" data-index="${index}" data-field="business_value">${escapeHtml(req.business_value || '')}</textarea>
                `;
                requirementsContainer.appendChild(card);
            });

            // добавляем обработчики для автосохранения изменений в currentRequirements
            document.querySelectorAll('.requirement-card input, .requirement-card textarea').forEach(el => {
                el.addEventListener('input', (e) => {
                    const index = e.target.dataset.index;
                    const field = e.target.dataset.field;
                    let value = e.target.value;
                    if (field === 'acceptance_criteria') {
                        value = value.split('\n').filter(line => line.trim() !== '');
                    }
                    if (!currentRequirements[index]) return;
                    currentRequirements[index][field] = value;
                });
            });
        }

        // вспомогательная функция для экранирования HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // удаление требования
        window.removeRequirement = function(index) {
            currentRequirements.splice(index, 1);
            renderRequirements();
        };

        cancelReqBtn.onclick = () => {
            reqModal.style.display = 'none';
            currentRequirements = [];
        };

        // повторная генерация с текущими правками (или исходным фидбеком)
        regenerateReqBtn.onclick = async () => {
            // можно использовать отредактированный фидбек из input
            const feedback = input.value.trim();
            const model = modelSelect.value;
            try {
                const res = await fetch("/api/generate_business_requirements", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        analysis_id: currentAnalysisId,
                        feedback: feedback,
                        model: model,
                        project_id: currentProjectId
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    currentRequirements = data.requirements;
                    renderRequirements();
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            } catch (e) {
                alert(`Ошибка сети: ${e}`);
            }
        };

        saveReqBtn.onclick = async () => {
            if (!currentAnalysisId || !currentProjectId) return;
            try {
                const res = await fetch("/api/save_business_requirements", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        project_id: currentProjectId,
                        parent_id: currentAnalysisId,
                        requirements: currentRequirements
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`Сохранено требований: ${data.ids.length}`);
                    reqModal.style.display = 'none';
                    currentRequirements = [];
                    await loadParents(); // обновляем список артефактов
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            } catch (e) {
                alert(`Ошибка сети: ${e}`);
            }
        };

        async function fetchModels() {
            try {
                const res = await fetch("/api/models");
                const models = await res.json();
                modelSelect.innerHTML = "";
                models.forEach(m => {
                    const opt = document.createElement("option");
                    opt.value = m.id;
                    opt.innerText = m.id.toUpperCase();
                    if (m.id === "openai/gpt-oss-120b" || m.id === "llama-3.3-70b-versatile") {
                        opt.selected = true;
                    }
                    modelSelect.appendChild(opt);
                });
            } catch (e) {
                modelSelect.innerHTML = '<option value="llama-3.3-70b-versatile">LLAMA-3.3-70B (FALLBACK)</option>';
            }
        }

        async function start() {
            const prompt = input.value.trim();
            if (!prompt) return;
            if (!currentProjectId) {
                alert("Сначала выберите проект");
                return;
            }
            const mode = document.getElementById("mode-select").value;
            const model = modelSelect.value;

            input.value = ""; input.style.height = "44px";
            input.disabled = true; sendBtn.disabled = true;
            statusText.innerText = "NEURAL_LINK_ESTABLISHED...";

            const u = document.createElement("div");
            u.className = "border-l-2 border-zinc-800 pl-6 text-sm text-zinc-400";
            u.innerText = prompt;
            messagesDiv.appendChild(u);

            const a = document.createElement("div");
            a.className = "markdown-body streaming";
            messagesDiv.appendChild(a);
            a.dataset.originalPrompt = prompt;
            const toolbar = createMessageToolbar(a);
            messagesDiv.appendChild(toolbar);

            try {
                const res = await fetch("/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt, mode, model, project_id: currentProjectId })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let raw = "";
                let metaDone = false;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    let chunk = decoder.decode(value);

                    if (!metaDone && chunk.includes("__METADATA__")) {
                        const parts = chunk.split("__");
                        const meta = parts[2].split("|");
                        document.getElementById("q-tokens").innerText = meta[0];
                        document.getElementById("q-req").innerText = meta[1];
                        chunk = parts.slice(3).join("__");
                        metaDone = true;
                    }

                    raw += chunk;
                    a.innerHTML = marked.parse(raw);
                    a.dataset.rawMarkdown = raw;
                    scrollAnchor.scrollIntoView({ behavior: "smooth" });
                }
            } catch (e) {
                a.innerHTML = `<span class="text-red-500">SYSTEM_ERROR: ${e.message}</span>`;
            } finally {
                a.classList.remove("streaming");
                input.disabled = false; sendBtn.disabled = false;
                statusText.innerText = "SYSTEM_READY";
                input.focus();
            }
        }

        function createMessageToolbar(messageElement) {
            const toolbar = document.createElement("div");
            toolbar.className = "message-toolbar";

            const copyBtn = document.createElement("button");
            copyBtn.innerText = "Copy";
            copyBtn.onclick = async () => {
                try { await navigator.clipboard.writeText(messageElement.innerText); } catch (_) {
                    const textarea = document.createElement("textarea");
                    textarea.value = messageElement.innerText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textarea);
                }
            };

            const editBtn = document.createElement("button");
            editBtn.innerText = "Edit";
            editBtn.onclick = () => {
                const raw = messageElement.dataset.rawMarkdown || messageElement.innerText;
                const editArea = document.createElement("textarea");
                editArea.value = raw;
                editArea.className = "w-full bg-transparent text-gray-200 p-2 border border-zinc-700 rounded";
                const saveBtn = document.createElement("button");
                saveBtn.innerText = "Save";
                saveBtn.className = "ml-2 p-1 bg-emerald-600/20 rounded";
                saveBtn.onclick = () => {
                    const newRaw = editArea.value;
                    messageElement.innerHTML = marked.parse(newRaw);
                    messageElement.dataset.rawMarkdown = newRaw;
                    editArea.remove();
                    saveBtn.remove();
                };
                messageElement.appendChild(editArea);
                messageElement.appendChild(saveBtn);
            };

            const regenerateBtn = document.createElement("button");
            regenerateBtn.innerText = "Regenerate";
            regenerateBtn.onclick = async () => {
                const original = messageElement.dataset.originalPrompt;
                if (!original) return;
                input.value = original;
                input.style.height = "auto";
                await start();
            };

            const shareBtn = document.createElement("button");
            shareBtn.innerText = "Share";
            shareBtn.onclick = async () => {
                const shareText = `Shared Message:\n${messageElement.innerText}`;
                try { await navigator.clipboard.writeText(shareText); } catch (_) {
                    const textarea = document.createElement("textarea");
                    textarea.value = shareText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textarea);
                }
            };

            toolbar.appendChild(copyBtn);
            toolbar.appendChild(editBtn);
            toolbar.appendChild(regenerateBtn);
            toolbar.appendChild(shareBtn);
            return toolbar;
        }

        window.onload = async function() {
            await fetchModels();
            await loadProjects();
            if (currentProjectId) await loadParents();
        };
        sendBtn.onclick = start;
        input.onkeydown = (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); start(); } };
    </script>
</body>
</html>
