<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRAK-OS | DYNAMIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; background-color: #0a0a0b; color: #d1d5db; }
        .markdown-body { font-size: 1.2rem; line-height: 1.7; }
        .markdown-body code { color: #6ee7b7; background: #1a1a1c; padding: 0.2rem 0.4rem; border-radius: 4px; }
        .markdown-body pre { background: #000; border: 1px solid #222; padding: 1.5rem; border-radius: 12px; margin: 1.2rem 0; overflow-x: auto; }
        .streaming::after { content: '‚ñã'; animation: blink 1s infinite; color: #059669; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }
        select option { background: #111; color: #d1d5db; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .message-toolbar { display: flex; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.75rem; color: #9ca3af; }
        .message-toolbar button { background: transparent; border: none; cursor: pointer; padding: 0.2rem 0.4rem; border-radius: 4px; transition: background-color 0.2s; }
        .message-toolbar button:hover { background: #111; }
        .spinner { border: 2px solid rgba(255,255,255,0.1); border-top-color: #10b981; border-radius: 50%; width: 1rem; height: 1rem; animation: spin 0.6s linear infinite; display: inline-block; margin-right: 0.25rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="h-screen flex flex-col antialiased overflow-hidden">

    <nav class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-black/40 backdrop-blur-xl shrink-0">
        <div class="flex items-center gap-6">
            <div class="flex flex-col">
                <span class="text-[8px] tracking-[0.3em] text-emerald-500 font-bold uppercase">Prompt_Mode</span>
                <select id="mode-select" class="bg-transparent text-[10px] text-white font-mono outline-none cursor-pointer">
                    <option value="01_CORE">01: CORE_SYSTEM</option>
                    <option value="02_IDEA_CLARIFIER">02: IDEA_CLARIFIER</option>
                    <option value="03_PRODUCT_COUNCIL">03: PRODUCT_COUNCIL</option>
                    <option value="04_BUSINESS_REQ_GEN">04: BUSINESS_REQ_GEN</option>
                    <option value="05_REQ_ENG_COUNCIL">05: REQ_ENG_COUNCIL</option>
                    <option value="06_SYSTEM_REQ_GEN">06: SYSTEM_REQ_GEN</option>
                    <option value="07_QA_COUNCIL">07: QA_COUNCIL</option>
                    <option value="08_ARCHITECTURE_COUNCIL">08: ARCHITECTURE_COUNCIL</option>
                    <option value="09_CODE_TASK_GEN">09: CODE_TASK_GEN</option>
                    <option value="10_CODE_GEN">10: CODE_GEN</option>
                    <option value="11_TEST_GEN">11: TEST_GEN</option>
                    <option value="12_FAILURE_DETECTOR">12: FAILURE_DETECTOR</option>
                    <option value="13_SELF_ANALYSIS_FACTORY">13: SELF_ANALYSIS_FACTORY</option>
                    <option value="14_PROMPT_ENGINEERING_COUNCIL">14: PROMPT_ENGINEERING_COUNCIL</option>
                    <option value="15_ALGORITHM_COUNCIL">15: ALGORITHM_COUNCIL</option>
                    <option value="16_UI_UX_COUNCIL">16: UI_UX_COUNCIL</option>
                    <option value="17_SOFT_ENG_COUNCIL">17: SOFT_ENG_COUNCIL</option>
                    <option value="18_TRANSLATOR">18: TRANSLATOR</option>
                    <option value="19_INTEGRATION_PLAN">19: INTEGRATION_PLAN</option>
                    <option value="20_SECURITY_REQ_GEN">20: SECURITY_REQ_GEN</option>
                    <option value="21_THREAT_MODELING_ASSISTANT">21: THREAT_MODELING_ASSISTANT</option>
                    <option value="22_INFRASTRUCTURE_SPEC_GEN">22: INFRASTRUCTURE_SPEC_GEN</option>
                    <option value="23_OBSERVABILITY_SPEC_GEN">23: OBSERVABILITY_SPEC_GEN</option>
                    <option value="24_TECH_DESIGN_DOC_GEN">24: TECH_DESIGN_DOC_GEN</option>
                    <option value="25_USER_DOC_GEN">25: USER_DOC_GEN</option>
                    <option value="26_API_DOC_GEN">26: API_DOC_GEN</option>
                    <option value="27_UAT_SCRIPT_GEN">27: UAT_SCRIPT_GEN</option>
                    <option value="28_JIRA_ISSUE_FORMATTER">28: JIRA_ISSUE_FORMATTER</option>
                    <option value="29_PROJECT_STATUS_REPORTER">29: PROJECT_STATUS_REPORTER</option>
                    <option value="30_INCIDENT_POST_MORTEM_GEN">30: INCIDENT_POST_MORTEM_GEN</option>
                    <option value="31_KNOWLEDGE_QUERY_ASSISTANT">31: KNOWLEDGE_QUERY_ASSISTANT</option>
                    <option value="32_CHANGE_IMPACT_ANALYZER">32: CHANGE_IMPACT_ANALYZER</option>
                    <option value="33_FEATURE_TO_USER_STORY_GEN">33: FEATURE_TO_USER_STORY_GEN</option>
                    <option value="34_RESEARCH_METODOLOGY_GEN">34: RESEARCH_METODOLOGY_GEN</option>
                    <option value="35_ANALYSIS_SUMMARIZER">35: ANALYSIS_SUMMARIZER</option>
                    <option value="36_REQUIREMENT_SUMMARIZER">36: REQUIREMENT_SUMMARIZER</option>
                    <option value="37_SYSTEM_REQUIREMENTS_SUMMARIZER">37: SYSTEM_REQUIREMENTS_SUMMARIZER</option>
                    <option value="38_CODE_CONTEXT_SUMMARIZER">38: CODE_CONTEXT_SUMMARIZER</option>
                </select>
            </div>
            <div class="flex flex-col">
                <span class="text-[8px] tracking-[0.3em] text-zinc-500 font-bold uppercase">Neural_Model</span>
                <select id="model-select" class="bg-transparent text-[10px] text-white font-mono outline-none cursor-pointer">
                    <option>Loading models...</option>
                </select>
            </div>
        </div>
        <div class="flex gap-4 text-[9px] font-mono text-zinc-600">
            <span>TOKENS: <b id="q-tokens" class="text-zinc-400">---</b></span>
            <span>REQ: <b id="q-req" class="text-zinc-400">---</b></span>
        </div>
    </nav>

    <div class="px-6 py-2 bg-emerald-500/5 border-b border-white/5 text-[9px] text-zinc-500 flex justify-between">
        <span id="status-text">SYSTEM_READY</span>
        <span id="token-count">EST_COST: 0 TOKENS</span>
    </div>

    <!-- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ -->
    <div class="px-6 py-2 bg-zinc-900 border-b border-white/5 flex flex-wrap items-center gap-4">
        <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">–ü—Ä–æ–µ–∫—Ç:</span>
            <select id="project-select" class="bg-zinc-800 text-white text-sm px-3 py-1 rounded border border-white/10 w-64">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
            </select>
            <button id="new-project-btn" class="bg-emerald-600/20 text-emerald-500 text-xs px-3 py-1 rounded hover:bg-emerald-600/30">+ –ù–æ–≤—ã–π</button>
            <button id="delete-project-btn" class="bg-red-600/20 text-red-500 text-xs px-3 py-1 rounded hover:bg-red-600/30 ml-2">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">–¢–∏–ø:</span>
            <select id="artifact-type-select" class="bg-zinc-800 text-white text-sm px-3 py-1 rounded border border-white/10">
                <option value="BusinessIdea">–ë–∏–∑–Ω–µ—Å-–∏–¥–µ—è</option>
                <option value="ProductCouncilAnalysis">–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–≥–æ —Å–æ–≤–µ—Ç–∞</option>
                <option value="BusinessRequirementPackage">–ü–∞–∫–µ—Ç –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π</option>
                <option value="ReqEngineeringAnalysis">–ê–Ω–∞–ª–∏–∑ –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π</option>
                <option value="FunctionalRequirementPackage">–ü–∞–∫–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π</option>
                <option value="CodeArtifact">–ö–æ–¥</option>
            </select>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-xs text-zinc-400">–†–æ–¥–∏—Ç–µ–ª—å:</span>
            <select id="parent-select" class="bg-zinc-800 text-white text-sm px-3 py-1 rounded border border-white/10 w-64">
                <option value="">-- –Ω–µ—Ç --</option>
            </select>
            <button id="refresh-parents" class="bg-zinc-700 text-white text-xs px-2 py-1 rounded">‚ü≤</button>
            <button id="delete-artifact-btn" class="bg-red-600/20 text-red-500 text-xs px-3 py-1 rounded hover:bg-red-600/30 ml-2">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π</button>
        </div>
        <div class="flex items-center gap-2">
            <label class="flex items-center gap-1 text-xs">
                <input type="checkbox" id="generate-checkbox" class="form-checkbox h-4 w-4 text-emerald-500 bg-zinc-800 border-white/10 rounded"> –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
            </label>
        </div>
        <button id="generate-artifact-btn" class="bg-emerald-600/20 text-emerald-500 text-xs px-3 py-1 rounded hover:bg-emerald-600/30" style="display:none;">–°–æ–∑–¥–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="save-artifact-btn" class="bg-emerald-600/20 text-emerald-500 text-xs px-3 py-1 rounded hover:bg-emerald-600/30">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç</button>
    </div>

    <main id="terminal" class="flex-1 overflow-y-auto px-6 scroll-smooth">
        <div id="messages" class="max-w-3xl mx-auto py-12 space-y-12"></div>
        <div id="scroll-anchor" class="h-32"></div>
    </main>

    <footer class="p-6 bg-gradient-to-t from-black to-transparent shrink-0">
        <div class="max-w-3xl mx-auto">
            <div class="flex items-end gap-3 bg-[#111113] border border-white/5 rounded-2xl p-3 transition-all duration-300 focus-within:border-emerald-500">
                <textarea id="input" class="w-full bg-transparent text-gray-200 py-2 px-3 outline-none resize-none h-[44px] max-h-[300px] text-sm" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..."></textarea>
                <button id="send-btn" class="p-2 bg-emerald-600/10 text-emerald-500 rounded-xl hover:bg-emerald-600/20 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2"/></svg>
                </button>
            </div>
        </div>
    </footer>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ -->
    <script src="api.js"></script>
    <script src="state.js"></script>
    <script src="ui.js"></script>
    <script>
        (function() {
            const input = document.getElementById("input");
            const sendBtn = document.getElementById("send-btn");
            const messagesDiv = document.getElementById("messages");
            const scrollAnchor = document.getElementById("scroll-anchor");
            const modelSelect = document.getElementById("model-select");
            const statusText = document.getElementById("status-text");
            const projectSelect = document.getElementById("project-select");
            const newProjectBtn = document.getElementById("new-project-btn");
            const artifactTypeSelect = document.getElementById("artifact-type-select");
            const parentSelect = document.getElementById("parent-select");
            const refreshParentsBtn = document.getElementById("refresh-parents");
            const generateCheckbox = document.getElementById("generate-checkbox");
            const saveArtifactBtn = document.getElementById("save-artifact-btn");
            const generateArtifactBtn = document.getElementById("generate-artifact-btn");
            const deleteProjectBtn = document.getElementById("delete-project-btn");
            const deleteArtifactBtn = document.getElementById("delete-artifact-btn");

            // –§–ª–∞–≥ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
            let isSaving = false;

            marked.setOptions({ gfm: true, breaks: true });

            input.oninput = function () {
                this.style.height = "auto";
                this.style.height = this.scrollHeight + "px";
                document.getElementById("token-count").innerText = `EST_COST: ~${Math.ceil(this.value.length / 4)} TOKENS`;
            };

            function setLoading(button, isLoading) {
                if (!button) return;
                if (isLoading) {
                    button.disabled = true;
                    button.dataset.originalText = button.innerText;
                    button.innerHTML = '<span class="spinner"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
                } else {
                    button.disabled = false;
                    button.innerText = button.dataset.originalText || button.innerText;
                }
            }

            async function loadProjects() {
                try {
                    const projects = await api.fetchProjects();
                    state.setProjects(projects);
                    ui.renderProjectSelect(projects, state.getCurrentProjectId());
                } catch (e) {
                    ui.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤: ' + e.message, 'error');
                }
            }

            newProjectBtn.onclick = async () => {
                const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:");
                if (!name) return;
                setLoading(newProjectBtn, true);
                try {
                    const data = await api.createProject(name, "");
                    await loadProjects();
                    projectSelect.value = data.id;
                    state.setCurrentProjectId(data.id);
                    await loadParents();
                    ui.showNotification('–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω', 'success');
                } catch (e) {
                    ui.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ' + e.message, 'error');
                } finally {
                    setLoading(newProjectBtn, false);
                }
            };

            async function loadParents() {
                const pid = state.getCurrentProjectId();
                if (!pid) return;
                setLoading(refreshParentsBtn, true);
                try {
                    const artifacts = await api.fetchArtifacts(pid);
                    state.setArtifacts(artifacts);
                    ui.renderParentSelect(artifacts, state.getParentData(), state.getCurrentParentId(), artifactTypeSelect.value);
                } catch (e) {
                    ui.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤: ' + e.message, 'error');
                } finally {
                    setLoading(refreshParentsBtn, false);
                }
            }

            refreshParentsBtn.onclick = loadParents;

            projectSelect.addEventListener("change", function() {
                state.setCurrentProjectId(this.value);
                if (this.value) {
                    loadParents();
                } else {
                    parentSelect.innerHTML = '<option value="">-- –Ω–µ—Ç --</option>';
                    generateArtifactBtn.style.display = 'none';
                }
            });

            parentSelect.addEventListener('change', function() {
                const selectedId = this.value;
                state.setCurrentParentId(selectedId);
                ui.updateGenerateButton(state.getParentData(), selectedId, artifactTypeSelect.value);
            });

            artifactTypeSelect.addEventListener('change', function() {
                const selectedParentId = parentSelect.value;
                if (selectedParentId) {
                    ui.updateGenerateButton(state.getParentData(), selectedParentId, artifactTypeSelect.value);
                }
                // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–æ–¥–∏—Ç–µ–ª–µ–π —Å —É—á—ë—Ç–æ–º –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞
                loadParents();
            });

            saveArtifactBtn.onclick = async () => {
                if (isSaving) return;
                const content = input.value.trim();
                if (!content) {
                    ui.showNotification("–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞", 'error');
                    return;
                }
                const pid = state.getCurrentProjectId();
                if (!pid) {
                    ui.showNotification("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç", 'error');
                    return;
                }
                const artifactType = artifactTypeSelect.value;
                const parentId = parentSelect.value || null;
                const generate = generateCheckbox.checked;
                const model = modelSelect.value;

                isSaving = true;
                setLoading(saveArtifactBtn, true);
                try {
                    const data = await api.saveArtifact(pid, artifactType, content, parentId, generate, model);
                    ui.showNotification(`–ê—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω, ID: ${data.id}`, 'success');
                    input.value = "";
                    input.style.height = "44px";
                    await loadParents();
                } catch (e) {
                    ui.showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'error');
                } finally {
                    setLoading(saveArtifactBtn, false);
                    isSaving = false;
                }
            };

            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            generateArtifactBtn.onclick = async () => {
                const parentId = parentSelect.value;
                const childType = artifactTypeSelect.value;
                if (!parentId || !childType) return;
                const feedback = input.value.trim();
                const model = modelSelect.value;
                const pid = state.getCurrentProjectId();
                if (!pid) return;

                setLoading(generateArtifactBtn, true);
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
                    let cached = state.getArtifactCache(parentId, childType);
                    let contentToShow;

                    if (cached && cached.content) {
                        contentToShow = cached.content;
                        state.setCurrentArtifact(cached);
                    } else {
                        // –ö–µ—à–∞ –Ω–µ—Ç, –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
                        const data = await api.fetchLatestArtifact(parentId, childType);
                        if (data.exists) {
                            state.setArtifactCache(parentId, childType, {
                                id: data.artifact_id,
                                content: data.content
                            });
                            contentToShow = data.content;
                            state.setCurrentArtifact({
                                id: data.artifact_id,
                                content: data.content
                            });
                        } else {
                            // –ù–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
                            const genData = await api.generateArtifact(childType, parentId, feedback, model, pid, null);
                            // –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–µ result (–º–∞—Å—Å–∏–≤ –∏–ª–∏ –æ–±—ä–µ–∫—Ç)
                            contentToShow = genData.result;
                            state.setCurrentArtifact({ content: contentToShow });
                        }
                    }

                    const handleSave = async () => {
                        if (isSaving) return;
                        isSaving = true;
                        let currentContent = state.getCurrentArtifact()?.content;
                        if (currentContent === undefined) {
                            currentContent = (childType === 'BusinessRequirementPackage' || childType === 'FunctionalRequirementPackage') ? [] : {};
                        }
                        try {
                            const saved = await api.saveArtifactPackage(pid, parentId, childType, currentContent);
                            if (saved.duplicate) {
                                ui.showNotification(`–ü–∞–∫–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, ID: ${saved.id}`, 'info');
                            } else {
                                ui.showNotification(`–°–æ—Ö—Ä–∞–Ω—ë–Ω –ø–∞–∫–µ—Ç, ID: ${saved.id}`, 'success');
                            }
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
                            state.setArtifactCache(parentId, childType, {
                                id: saved.id,
                                content: currentContent
                            });
                            ui.closeModal();
                            await loadParents();
                        } catch (e) {
                            ui.showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'error');
                        } finally {
                            isSaving = false;
                        }
                    };

                    const handleAddMore = async () => {
                        if (isSaving) return;
                        isSaving = true;
                        const newFeedback = input.value.trim();
                        const existingContent = state.getCurrentArtifact()?.content;
                        try {
                            const newData = await api.generateArtifact(childType, parentId, newFeedback, model, pid, existingContent);
                            const newContent = newData.result;
                            let combined;
                            if (childType === 'BusinessRequirementPackage' || childType === 'FunctionalRequirementPackage') {
                                const currentArray = Array.isArray(existingContent) ? existingContent : [];
                                const newArray = Array.isArray(newContent) ? newContent : [];
                                combined = currentArray.concat(newArray);
                            } else {
                                combined = newContent;
                            }
                            state.setCurrentArtifact({ content: combined });
                            ui.openRequirementsModal(
                                childType,
                                combined,
                                handleSave,
                                handleAddMore,
                                () => { ui.closeModal(); }
                            );
                        } catch (e) {
                            ui.showNotification('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + e.message, 'error');
                        } finally {
                            isSaving = false;
                        }
                    };

                    ui.openRequirementsModal(
                        childType,
                        contentToShow,
                        handleSave,
                        handleAddMore,
                        () => { ui.closeModal(); }
                    );
                } catch (e) {
                    ui.showNotification('–û—à–∏–±–∫–∞: ' + e.message, 'error');
                } finally {
                    setLoading(generateArtifactBtn, false);
                }
            };

            // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
            deleteProjectBtn.onclick = async () => {
                const pid = state.getCurrentProjectId();
                if (!pid) {
                    ui.showNotification("–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞", "error");
                    return;
                }
                if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏ –≤—Å–µ –µ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) return;
                try {
                    const res = await fetch(`/api/projects/${pid}`, { method: "DELETE" });
                    if (res.ok) {
                        ui.showNotification("–ü—Ä–æ–µ–∫—Ç —É–¥–∞–ª—ë–Ω", "success");
                        state.setCurrentProjectId("");
                        await loadProjects();
                        parentSelect.innerHTML = '<option value="">-- –Ω–µ—Ç --</option>';
                        generateArtifactBtn.style.display = "none";
                    } else {
                        const err = await res.json();
                        ui.showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + err.error, "error");
                    }
                } catch (e) {
                    ui.showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message, "error");
                }
            };

            // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
            deleteArtifactBtn.onclick = async () => {
                const aid = parentSelect.value;
                if (!aid) {
                    ui.showNotification("–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞", "error");
                    return;
                }
                if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç? –î–æ—á–µ—Ä–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –Ω–æ –ø–æ—Ç–µ—Ä—è—é—Ç —Å–≤—è–∑—å.")) return;
                try {
                    const res = await fetch(`/api/artifacts/${aid}`, { method: "DELETE" });
                    if (res.ok) {
                        ui.showNotification("–ê—Ä—Ç–µ—Ñ–∞–∫—Ç —É–¥–∞–ª—ë–Ω", "success");
                        await loadParents();
                    } else {
                        const err = await res.json();
                        ui.showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + err.error, "error");
                    }
                } catch (e) {
                    ui.showNotification("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message, "error");
                }
            };

            async function loadModels() {
                try {
                    const models = await api.fetchModels();
                    state.setModels(models);
                    modelSelect.innerHTML = '';
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.innerText = m.id.toUpperCase();
                        if (m.id === "openai/gpt-oss-120b" || m.id === "llama-3.3-70b-versatile") {
                            opt.selected = true;
                        }
                        modelSelect.appendChild(opt);
                    });
                } catch (e) {
                    ui.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π: ' + e.message, 'error');
                }
            }

            window.onload = async function() {
                await loadModels();
                await loadProjects();
                if (state.getCurrentProjectId()) await loadParents();
            };

            async function start() {
                const prompt = input.value.trim();
                if (!prompt) return;
                const pid = state.getCurrentProjectId();
                if (!pid) {
                    ui.showNotification("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç", 'error');
                    return;
                }
                const mode = document.getElementById("mode-select").value;
                const model = modelSelect.value;

                input.value = ""; input.style.height = "44px";
                input.disabled = true; sendBtn.disabled = true;
                statusText.innerText = "NEURAL_LINK_ESTABLISHED...";

                const userDiv = document.createElement("div");
                userDiv.className = "border-l-2 border-zinc-800 pl-6 text-sm text-zinc-400";
                userDiv.innerText = prompt;
                messagesDiv.appendChild(userDiv);

                const assistantDiv = document.createElement("div");
                assistantDiv.className = "markdown-body streaming";
                messagesDiv.appendChild(assistantDiv);
                assistantDiv.dataset.originalPrompt = prompt;
                const toolbar = createMessageToolbar(assistantDiv);
                messagesDiv.appendChild(toolbar);

                try {
                    const res = await fetch("/api/analyze", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt, mode, model, project_id: pid })
                    });
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let raw = "";
                    let metaDone = false;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        let chunk = decoder.decode(value);
                        if (!metaDone && chunk.includes("__METADATA__")) {
                            const parts = chunk.split("__");
                            const meta = parts[2].split("|");
                            document.getElementById("q-tokens").innerText = meta[0];
                            document.getElementById("q-req").innerText = meta[1];
                            chunk = parts.slice(3).join("__");
                            metaDone = true;
                        }
                        raw += chunk;
                        assistantDiv.innerHTML = marked.parse(raw);
                        assistantDiv.dataset.rawMarkdown = raw;
                        scrollAnchor.scrollIntoView({ behavior: "smooth" });
                    }
                } catch (e) {
                    assistantDiv.innerHTML = `<span class="text-red-500">SYSTEM_ERROR: ${e.message}</span>`;
                } finally {
                    assistantDiv.classList.remove("streaming");
                    input.disabled = false; sendBtn.disabled = false;
                    statusText.innerText = "SYSTEM_READY";
                    input.focus();
                }
            }

            sendBtn.onclick = start;
            input.onkeydown = (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); start(); } };

            function createMessageToolbar(messageElement) {
                const toolbar = document.createElement("div");
                toolbar.className = "message-toolbar";
                const copyBtn = document.createElement("button");
                copyBtn.innerText = "Copy";
                copyBtn.onclick = async () => {
                    try { await navigator.clipboard.writeText(messageElement.innerText); } catch (_) {
                        const textarea = document.createElement("textarea");
                        textarea.value = messageElement.innerText;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand("copy");
                        document.body.removeChild(textarea);
                    }
                };
                const editBtn = document.createElement("button");
                editBtn.innerText = "Edit";
                editBtn.onclick = () => {
                    const raw = messageElement.dataset.rawMarkdown || messageElement.innerText;
                    const editArea = document.createElement("textarea");
                    editArea.value = raw;
                    editArea.className = "w-full bg-transparent text-gray-200 p-2 border border-zinc-700 rounded";
                    const saveBtn = document.createElement("button");
                    saveBtn.innerText = "Save";
                    saveBtn.className = "ml-2 p-1 bg-emerald-600/20 rounded";
                    saveBtn.onclick = () => {
                        const newRaw = editArea.value;
                        messageElement.innerHTML = marked.parse(newRaw);
                        messageElement.dataset.rawMarkdown = newRaw;
                        editArea.remove();
                        saveBtn.remove();
                    };
                    messageElement.appendChild(editArea);
                    messageElement.appendChild(saveBtn);
                };
                const regenerateBtn = document.createElement("button");
                regenerateBtn.innerText = "Regenerate";
                regenerateBtn.onclick = async () => {
                    const original = messageElement.dataset.originalPrompt;
                    if (!original) return;
                    input.value = original;
                    input.style.height = "auto";
                    await start();
                };
                const shareBtn = document.createElement("button");
                shareBtn.innerText = "Share";
                shareBtn.onclick = async () => {
                    const shareText = `Shared Message:\n${messageElement.innerText}`;
                    try { await navigator.clipboard.writeText(shareText); } catch (_) {
                        const textarea = document.createElement("textarea");
                        textarea.value = shareText;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand("copy");
                        document.body.removeChild(textarea);
                    }
                };
                toolbar.appendChild(copyBtn);
                toolbar.appendChild(editBtn);
                toolbar.appendChild(regenerateBtn);
                toolbar.appendChild(shareBtn);
                return toolbar;
            }
        })();
    </script>
</body>
</html>
